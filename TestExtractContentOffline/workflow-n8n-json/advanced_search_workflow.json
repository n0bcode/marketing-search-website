{
  "name": "Advanced Search with Telegram and Bing",
  "nodes": [
    {
      "parameters": {
        "events": [
          "message"
        ]
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        250,
        300
      ],
      "credentials": {
        "telegramApi": {
          "id": "YOUR_TELEGRAM_API_KEY",
          "name": "Telegram API"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "query",
              "value": "{{$json.message.text.match(/search query: (.*?) (site:|filetype:|$)/)[1]}}"
            },
            {
              "name": "site",
              "value": "{{$json.message.text.match(/site: (.*?) (filetype:|$)/) ? $json.message.text.match(/site: (.*?) (filetype:|$)/)[1] : ''}}"
            },
            {
              "name": "filetype",
              "value": "{{$json.message.text.match(/filetype: (.*?)$/) ? $json.message.text.match(/filetype: (.*?)$/)[1] : ''}}"
            }
          ]
        },
        "options": {}
      },
      "name": "Extract Search Parameters",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "url": "https://www.bing.com/search?q={{$json.query}}{{$json.site ? ' site:' + $json.site : ''}}{{$json.filetype ? ' filetype:' + $json.filetype : ''}}",
        "options": {}
      },
      "name": "Bing Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "mode": "cssSelector",
        "selector": "#b_results .b_algo",
        "returnValue": "html",
        "value": "{{$json.data}}",
        "options": {
          "extractAttributes": [
            {
              "extractValue": "h2 a",
              "attribute": "text",
              "dataProperty": "title"
            },
            {
              "extractValue": "h2 a",
              "attribute": "href",
              "dataProperty": "url"
            },
            {
              "extractValue": ".b_caption p",
              "attribute": "text",
              "dataProperty": "snippet"
            }
          ]
        }
      },
      "name": "Scrape Results",
      "type": "n8n-nodes-base.html",
      "typeVersion": 1,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "mode": "create",
        "options": {}
      },
      "name": "Item Lists (Create List)",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 1,
      "position": [
        1050,
        200
      ]
    },
    {
      "parameters": {
        "mode": "cssSelector",
        "selector": "a[aria-label=\"Next page\"]",
        "returnValue": "attribute",
        "attribute": "href",
        "value": "{{$json.data}}",
        "options": {}
      },
      "name": "Extract Next Page Link",
      "type": "n8n-nodes-base.html",
      "typeVersion": 1,
      "position": [
        1050,
        400
      ]
    },
    {
      "parameters": {
        "conditions": [
          {
            "value1": "={{$json.nextPageUrl}}",
            "value2": "={{\'\'}}",
            "operator": "notEqual"
          }
        ]
      },
      "name": "Has Next Page?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "nextPageUrl",
              "value": "{{$json.nextPageUrl}}"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Next Page URL",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        1450,
        200
      ]
    },
    {
      "parameters": {
        "url": "https://www.bing.com{{$json.nextPageUrl}}",
        "options": {}
      },
      "name": "HTTP Request (Next Page)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1650,
        200
      ]
    },
    {
      "parameters": {
        "mode": "cssSelector",
        "selector": "#b_results .b_algo",
        "returnValue": "html",
        "value": "{{$json.data}}",
        "options": {
          "extractAttributes": [
            {
              "extractValue": "h2 a",
              "attribute": "text",
              "dataProperty": "title"
            },
            {
              "extractValue": "h2 a",
              "attribute": "href",
              "dataProperty": "url"
            },
            {
              "extractValue": ".b_caption p",
              "attribute": "text",
              "dataProperty": "snippet"
            }
          ]
        }
      },
      "name": "Scrape Results (Next Page)",
      "type": "n8n-nodes-base.html",
      "typeVersion": 1,
      "position": [
        1850,
        200
      ]
    },
    {
      "parameters": {
        "mode": "add",
        "options": {}
      },
      "name": "Item Lists (Add Item)",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 1,
      "position": [
        2050,
        200
      ]
    },
    {
      "parameters": {
        "fileName": "bing_results_{{$timestamp}}.csv",
        "fileFormat": "csv",
        "options": {}
      },
      "name": "Create CSV",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 1,
      "position": [
        1450,
        400
      ]
    },
    {
      "parameters": {
        "chatId": "{{$json.message.chat.id}}",
        "file": "data",
        "options": {}
      },
      "name": "Send CSV to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1650,
        400
      ],
      "credentials": {
        "telegramApi": {
          "id": "YOUR_TELEGRAM_API_KEY",
          "name": "Telegram API"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Extract Search Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Search Parameters": {
      "main": [
        [
          {
            "node": "Bing Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bing Search": {
      "main": [
        [
          {
            "node": "Scrape Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scrape Results": {
      "main": [
        [
          {
            "node": "Item Lists (Create List)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Item Lists (Create List)": {
      "main": [
        [
          {
            "node": "Extract Next Page Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Next Page Link": {
      "main": [
        [
          {
            "node": "Has Next Page?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Next Page?": {
      "main": [
        [
          {
            "node": "Set Next Page URL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create CSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Next Page URL": {
      "main": [
        [
          {
            "node": "HTTP Request (Next Page)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request (Next Page)": {
      "main": [
        [
          {
            "node": "Scrape Results (Next Page)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scrape Results (Next Page)": {
      "main": [
        [
          {
            "node": "Item Lists (Add Item)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Item Lists (Add Item)": {
      "main": [
        [
          {
            "node": "Extract Next Page Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create CSV": {
      "main": [
        [
          {
            "node": "Send CSV to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}